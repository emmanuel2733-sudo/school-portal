<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Questions List</title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <style>
    :root {
      --primary: #6366f1;
      --success: #10b981;
      --danger: #e74a3b;
      --warning: #f59e0b;
      --info: #3b82f6;
      --card-bg: #f8fafc;
    }

    body {
      background: #f1f5f9;
      font-family: 'Segoe UI', sans-serif;
      padding-bottom: 60px;
    }

    /* HEADER NAV */
    .header-actions {
      display: flex;
      justify-content: space-between;
      margin: 20px auto;
      max-width: 1300px;
      padding: 0 20px;
    }

   .back-nav-btn { 
  background: var(--primary); 
  color: white; 
  width: 50px; 
  height: 50px;
  border-radius: 50%;
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 1.4rem;
  text-decoration: none;
  box-shadow: 0 5px 15px rgba(0,0,0,0.15);
}
.back-nav-btn:hover { 
  background: #4f46e5; 
  transform: scale(1.1); 
}

    .btn-bulk, .btn-ai {
      background: var(--success);
      color: white;
      padding: 12px 22px;
      border-radius: 8px;
      font-weight: 600;
      text-decoration: none;
      box-shadow: 0 5px 15px rgba(16,185,129,0.3);
      transition: .2s;
    }
    .btn-bulk:hover, .btn-ai:hover { background: #0da271; transform: translateY(-2px); }

    /* SUCCESS ALERT */
    .success-alert {
      max-width: 1300px;
      margin: 10px auto 0;
      padding: 15px 20px;
      background: #d1fae5;
      border-left: 6px solid #047857;
      color: #065f46;
      border-radius: 8px;
      font-weight: 600;
    }

    /* HEADER SECTION */
    .header-section {
      max-width: 1300px;
      margin: 20px auto;
      background: white;
      padding: 25px 30px;
      border-radius: 12px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.08);
      border: 1px solid #e2e8f0;
    }

    .header-title { font-size: 2rem; font-weight: 800; color: #1e293b; }
    .header-subtitle { font-size: 1.1rem; color: #64748b; margin-bottom: 10px; }

    /* Table header */
    .table-header {
      max-width: 1300px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 0.5fr 3fr 2fr 1fr 1fr 1fr;
      gap: 15px;
      padding: 20px;
      background: white;
      border-radius: 10px 10px 0 0;
      font-weight: 700;
      text-transform: uppercase;
      border: 1px solid #e2e8f0;
      border-bottom: 2px solid #e2e8f0;
      color: #475569;
    }

    /* Row cards */
    .table-body {
      max-width: 1300px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 15px;
      position: relative;
    }

    .table-row-card {
      display: grid;
      grid-template-columns: 0.5fr 3fr 2fr 1fr 1fr 1fr;
      gap: 15px;
      background: var(--card-bg);
      padding: 20px;
      border-radius: 10px;
      border: 1px solid #e2e8f0;
      transition: .3s;
      position: relative;
    }
    .table-row-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }

    .table-cell { color: #334155; font-weight: 500; }
    .question-text { font-weight: 700; color: #1e293b; }

    .correct-badge {
      background: var(--success);
      color: white;
      padding: 8px 15px;
      border-radius: 8px;
      font-weight: 700;
      text-align: center;
      min-width: 60px;
    }

    img.question-img {
      width: 100%;
      max-width: 110px;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }

    /* ACTIONS DROPDOWN FIX â€” COMPLETELY OUTSIDE THE CARD */
    .action-cell-wrapper {
      position: relative;
      width: 100%;
    }

    .action-btn {
      background: var(--primary);
      color: white;
      padding: 12px 18px;
      border-radius: 8px;
      width: 100%;
      border: none;
      cursor: pointer;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(99,102,241,0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.2s;
    }
    
    .action-btn:hover {
      background: #4f46e5;
    }

    /* DROPDOWN MENU - POSITIONED ABSOLUTELY OUTSIDE THE GRID */
    .dropdown-menu-container {
      position: fixed; /* Use fixed to break out of all containers */
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 10000;
      display: none;
      pointer-events: none;
    }

    .dropdown-menu-box {
      position: absolute;
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      min-width: 220px;
      box-shadow: 0 25px 50px rgba(0,0,0,0.25);
      z-index: 10001;
      pointer-events: auto;
      display: none;
      padding: 15px;
    }

    .dropdown-menu-box.active {
      display: block;
      animation: fadeIn 0.2s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Items */
    .dropdown-menu-box form {
      margin-bottom: 15px;
    }

    .dropdown-menu-box .form-select {
      width: 100%;
      margin-bottom: 10px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      padding: 8px 12px;
    }

    .dropdown-menu-box a,
    .dropdown-menu-box button {
      display: block;
      padding: 10px 15px;
      color: #334155;
      font-weight: 600;
      text-decoration: none;
      background: none;
      border: none;
      width: 100%;
      text-align: left;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .dropdown-menu-box a:hover,
    .dropdown-menu-box button:hover {
      background: #f1f5f9;
      color: var(--primary);
    }

    .delete-item { 
      color: var(--danger); 
    }
    
    .delete-item:hover { 
      background: #ffe4e4 !important; 
      color: #b91c1c !important; 
    }

    /* Overlay background when dropdown is open */
    .dropdown-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.1);
      z-index: 9999;
      display: none;
    }

    .dropdown-overlay.active {
      display: block;
    }

    /* PAGINATION */
    .pagination {
      margin-top: 30px;
    }
    
    .page-item.active .page-link {
      background-color: var(--primary);
      border-color: var(--primary);
    }
    
    .page-link {
      color: var(--primary);
    }
    
    .page-link:hover {
      color: #4f46e5;
    }

  </style>
</head>
<body>

<!-- SUCCESS MESSAGE -->
<% if (import_success) { %>
  <div class="success-alert">
    <i class="fas fa-check-circle"></i> Question imported successfully!
  </div>
<% } %>

<!-- TOP BUTTONS -->
<div class="header-actions">

  <a href="/teacher/question-bank" class="back-nav-btn">
         <i class="fas fa-arrow-left"></i>
  </a>

  <div>
    <% if (questions.length > 0) { %>
      <a href="/teacher/question-bank/<%= course_id %>/<%= class_id %>/ai"
         class="btn-bulk">
         ðŸ¤– Generate with AI
      </a>
    <% } %>

    <!-- <a href="/teacher/cbt/import/bulk?course=<%= course_id %>&class=<%= class_id %>"
       class="btn-bulk">
      <i class="fa-solid fa-layer-group"></i> Bulk Add to CBT
    </a> -->
  </div>

</div>

<!-- HEADER -->
<div class="header-section">
  <h1 class="header-title">QUESTION LIST</h1>
  <p class="header-subtitle">Manage questions for <%= course_name %> â€” <%= class_name %></p>
</div>

<!-- TABLE HEADER -->
<div class="table-header">
  <div>#</div>
  <div>Question</div>
  <div>Options</div>
  <div>Correct</div>
  <div>Image</div>
  <div>Actions</div>
</div>

<!-- DROPDOWN OVERLAY (for closing on click outside) -->
<div class="dropdown-overlay" id="dropdownOverlay"></div>

<!-- DROPDOWN CONTAINER (positioned globally) -->
<div class="dropdown-menu-container" id="globalDropdownContainer">
  <div class="dropdown-menu-box" id="globalDropdownMenu">
    <!-- Dropdown content will be injected here -->
  </div>
</div>

<!-- TABLE BODY -->
<div class="table-body">

  <% questions.forEach((q, i) => { %>
  <div class="table-row-card">

    <!-- Number -->
    <div class="table-cell"><%= i + 1 %></div>

    <!-- Question -->
    <div class="table-cell question-text"><%= q.question %></div>

    <!-- Options -->
    <div class="table-cell">
      <strong>A:</strong> <%= q.option1 %><br>
      <strong>B:</strong> <%= q.option2 %><br>
      <strong>C:</strong> <%= q.option3 || "â€”" %><br>
      <strong>D:</strong> <%= q.option4 || "â€”" %>
    </div>

    <!-- Correct -->
    <div class="table-cell">
      <% const L = {1:"A",2:"B",3:"C",4:"D"}; %>
      <span class="correct-badge">
        <%= L[q.correct_option] || q.correct_option || "?" %>
      </span>
    </div>

    <!-- Image -->
    <div class="table-cell">
      <% if (q.image_path) { %>
        <img src="/uploads/questions/<%= q.image_path %>" class="question-img">
      <% } else { %>
        <em style="color:#94a3b8;">No Image</em>
      <% } %>
    </div>

    <!-- ACTIONS BUTTON (no dropdown here, just the button) -->
    <div class="table-cell action-cell-wrapper">
      <button class="action-btn" 
              data-question-id="<%= q.id %>" 
              data-question-index="<%= i %>">
        Actions <i class="fas fa-chevron-down"></i>
      </button>
    </div>

  </div>
  <% }) %>

</div>

<!-- PAGINATION -->
<div class="d-flex justify-content-center mt-4 mb-5">
  <nav>
    <ul class="pagination">
      <!-- Previous button -->
      <li class="page-item <%= page === 1 ? 'disabled' : '' %>">
        <a class="page-link" href="?page=<%= page - 1 %>">&laquo; Prev</a>
      </li>

      <!-- Page numbers -->
      <% for (let p = 1; p <= totalPages; p++) { %>
        <li class="page-item <%= p === page ? 'active' : '' %>">
          <a class="page-link" href="?page=<%= p %>"><%= p %></a>
        </li>
      <% } %>

      <!-- Next button -->
      <li class="page-item <%= page === totalPages ? 'disabled' : '' %>">
        <a class="page-link" href="?page=<%= page + 1 %>">Next &raquo;</a>
      </li>
    </ul>
  </nav>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const dropdownContainer = document.getElementById('globalDropdownContainer');
  const dropdownMenu = document.getElementById('globalDropdownMenu');
  const dropdownOverlay = document.getElementById('dropdownOverlay');
  let currentQuestionId = null;
  
  // Function to close dropdown
  function closeDropdown() {
    dropdownContainer.style.display = 'none';
    dropdownMenu.classList.remove('active');
    dropdownOverlay.classList.remove('active');
    currentQuestionId = null;
  }
  
  // Function to position and show dropdown
  function showDropdown(button, questionId, questionIndex) {
    currentQuestionId = questionId;
    
    // Get button position
    const rect = button.getBoundingClientRect();
    
    // Position dropdown near the button
    dropdownMenu.style.left = Math.min(rect.right - 220, window.innerWidth - 250) + 'px';
    dropdownMenu.style.top = (rect.bottom + 10) + 'px';
    
    // Create dropdown content
    dropdownMenu.innerHTML = `
      <form action="/teacher/cbt/import-question" method="POST">
        <select name="examId" required class="form-select mb-2">
          <option value="">Select Exam</option>
          <% exams.forEach(ex => { %>
            <option value="<%= ex.id %>"><%= ex.title %> â€” <%= ex.class_name %></option>
          <% }) %>
        </select>
       <input type="hidden" name="qid" value="${questionId}">

        <input type="hidden" name="course_id" value="<%= course_id %>">
        <input type="hidden" name="class_id" value="<%= class_id %>">
        <button type="submit" class="action-item-btn" style="width:100%; padding:10px; background:#f1f5f9; border:none; border-radius:6px; cursor:pointer; font-weight:600;">
          <i class="fas fa-plus-circle"></i> Add to Exam
        </button>
      </form>
      
      <a href="/teacher/question-bank/${questionId}/edit" class="action-item" style="display:block; padding:10px; text-decoration:none; color:#334155; border-radius:6px; margin-bottom:5px;">
        <i class="fas fa-edit"></i> Edit Question
      </a>
      
      <form action="/teacher/question-bank/${questionId}/delete" method="POST">
        <button type="submit" class="delete-item" onclick="return confirm('Delete this question?')" style="width:100%; padding:10px; background:none; border:none; color:#e74a3b; text-align:left; border-radius:6px; cursor:pointer; font-weight:600;">
          <i class="fas fa-trash-alt"></i> Delete Question
        </button>
      </form>
    `;
    
    // Show dropdown
    dropdownContainer.style.display = 'block';
    setTimeout(() => {
      dropdownMenu.classList.add('active');
      dropdownOverlay.classList.add('active');
    }, 10);
  }
  
  // Add click event to all action buttons
  document.querySelectorAll('.action-btn').forEach(button => {
    button.addEventListener('click', function(e) {
      e.stopPropagation();
      e.preventDefault();
      
      const questionId = this.getAttribute('data-question-id');
      const questionIndex = this.getAttribute('data-question-index');
      
      // Close if clicking the same button
      if (currentQuestionId === questionId && dropdownContainer.style.display === 'block') {
        closeDropdown();
      } else {
        showDropdown(this, questionId, questionIndex);
      }
    });
  });
  
  // Close dropdown when clicking overlay
  dropdownOverlay.addEventListener('click', closeDropdown);
  
  // Close dropdown when clicking escape
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      closeDropdown();
    }
  });
  
  // Close dropdown when clicking anywhere else
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.action-btn') && !e.target.closest('.dropdown-menu-box')) {
      closeDropdown();
    }
  });
});
</script>

</body>
</html>
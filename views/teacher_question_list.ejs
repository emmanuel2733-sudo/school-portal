<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Questions List</title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <style>

    /* FULL LEFT OVERRIDE - FIXES BOOTSTRAP FLEX CENTERING */
.table-row-card,
.table-row-card * ,
.table-cell,
.table-cell *,
.option-column,
.option-item,
.question-text {
    text-align: left !important;
    justify-content: flex-start !important;
    align-items: flex-start !important;
}

    .table-header,
.table-row-card,
.table-body,
.table-cell,
.option-item,
.question-text {
  text-align: left !important;
  justify-content: flex-start !important;
}

    :root {
      --primary: #6366f1;
      --success: #10b981;
      --danger: #e74a3b;
      --card-bg: #f8fafc;
    }

    * { box-sizing: border-box; }

    /* TOP NAV */
    .top-nav {
      width: 100%;
      background: white;
      padding: 18px 25px;
      border-bottom: 1px solid #e2e8f0;
      box-shadow: 0 3px 10px rgba(0,0,0,0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 50;
    }

    .nav-title {
      font-size: 1.8rem;
      font-weight: 800;
      color: #1e293b;
    }

    .nav-back-btn {
      background: var(--primary);
      color: white;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 1.4rem;
      text-decoration: none;
      box-shadow: 0 5px 15px rgba(0,0,0,0.15);
      transition: .2s;
    }

    .nav-back-btn:hover {
      background: #4f46e5;
      transform: scale(1.05);
    }


    body {
      background: #f1f5f9;
      font-family: 'Segoe UI', sans-serif;
      padding-bottom: 60px;
    }

    /* HEADER ACTIONS */
 .header-actions {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-direction: row-reverse;   /* ‚Üê this flips both sides */
  margin: 20px auto;
  max-width: 95%;
  padding: 0 20px;
}
/* EXPAND WIDTH */
.header-actions,
.header-section,
.table-header,
.table-body,
.success-alert {
  max-width: 95% !important;
}

/* ALIGN EVERYTHING LEFT */
.table-header,
.table-row-card,
.table-body,
.table-cell,
.option-item,
.question-text {
  text-align: left !important;
  justify-content: flex-start !important;
}

/* WIDER GRID */
.table-header {
  grid-template-columns: 0.6fr 4fr 2.5fr 1fr 1fr 1fr !important;
}
.table-row-card {
  grid-template-columns: 0.6fr 4fr 2.5fr 1fr 1fr 1fr !important;
}

/* BIGGER IMAGE */
img.question-img {
  max-width: 150px !important;
}


    .back-nav-btn {
      background: var(--primary);
      color: white;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 1.4rem;
      text-decoration: none;
      box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    }
    .back-nav-btn:hover { background: #4f46e5; transform: scale(1.05); }

    .btn-bulk, .btn-ai {
      background: var(--success);
      color: white;
      padding: 12px 22px;
      border-radius: 8px;
      font-weight: 600;
      text-decoration: none;
      box-shadow: 0 5px 15px rgba(16,185,129,0.3);
      transition: .2s;
    }
    .btn-bulk[disabled] { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; }
    .btn-bulk:hover, .btn-ai:hover { background: #0da271; transform: translateY(-2px); }

    /* SUCCESS ALERT */
    .success-alert {
        max-width: 95%;
      margin: 10px auto 0;
      padding: 15px 20px;
      background: #d1fae5;
      border-left: 6px solid #047857;
      color: #065f46;
      border-radius: 8px;
      font-weight: 600;
    }

    /* HEADER SECTION */
    .header-section {
        max-width: 95%;
      margin: 20px auto;
      background: white;
      padding: 25px 30px;
      border-radius: 12px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.08);
      border: 1px solid #e2e8f0;
    }
    .header-title { font-size: 2rem; font-weight: 800; color: #1e293b; }
    .header-subtitle { font-size: 1.1rem; color: #64748b; margin-bottom: 10px; }

    /* Table header */
    .table-header {
        max-width: 95%;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 0.6fr 3fr 2fr 1fr 1fr 1fr; /* first column small for checkbox/number */
      gap: 15px;
      padding: 12px 20px;
      background: white;
      border-radius: 10px 10px 0 0;
      font-weight: 700;
      text-transform: uppercase;
      border: 1px solid #e2e8f0;
      border-bottom: 2px solid #e2e8f0;
      color: #475569;
      align-items: center;
    }

    .select-all {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 700;
    }
    .select-all input[type="checkbox"] {
      width: 18px; height: 18px;
    }

    /* Row cards */
    .table-body {
      max-width: 95%;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 15px;
      position: relative;
      padding: 0 20px 20px;
    }

    .table-row-card {
      display: grid;
      grid-template-columns: 0.6fr 3fr 2fr 1fr 1fr 1fr;
      gap: 15px;
      background: var(--card-bg);
      padding: 18px;
      border-radius: 10px;
      border: 1px solid #e2e8f0;
      transition: .3s;
      text-align: left;
      position: relative;
    }
    .table-row-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.12);
    }

    .table-cell { color: #334155; font-weight: 500; display:flex; align-items:center; gap:8px; text-align: left;}
    .question-text { font-weight: 700; color: #1e293b; }

    .correct-badge {
      background: var(--success);
      color: white;
      padding: 8px 15px;
      border-radius: 8px;
      font-weight: 700;
      text-align: center;
      min-width: 60px;
    }

    img.question-img {
      width: 100%;
       max-width: 95%;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }

    /* ACTIONS */
    .action-cell-wrapper { position: relative; width: 100%; }
    .action-btn {
      background: var(--primary);
      color: white;
      padding: 10px 12px;
      border-radius: 8px;
      width: 100%;
      border: none;
      cursor: pointer;
      font-weight: 600;
      display:flex; justify-content:flex-start; align-items:flex-start;
    }
.option-column {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.option-item {
  padding: 6px 10px;
  background: #ffffff;
  border-radius: 6px;
  border: 1px solid #e2e8f0;
  font-size: 0.95rem;
  font-weight: 500;
  color: #1e293b;
}

    /* DROPDOWN MENU (global) */
    .dropdown-menu-container { position: fixed; top:0; left:0; width:100%; height:100%; z-index:10000; display:none; pointer-events:none; }
    .dropdown-menu-box {
      position: absolute; background: white; min-width: 260px; border-radius: 10px; box-shadow: 0 20px 50px rgba(0,0,0,0.25);
      border: 1px solid #e2e8f0; padding: 12px; display:none; z-index:10001; pointer-events:auto;
    }
    .dropdown-menu-box.active { display:block; animation: fadeIn .15s ease; }
    @keyframes fadeIn { from { opacity:0; transform: translateY(-6px) } to { opacity:1; transform: translateY(0) } }

    /* MODAL (bulk import) */
    .bulk-modal-backdrop {
      position: fixed; inset: 0; background: rgba(0,0,0,0.35); display:none; z-index: 10500;
      align-items: center; justify-content:center;
    }
    .bulk-modal {
      width: 100%;
       max-width: 95%;
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.25);
    }
    .modal-header { display:flex; justify-content:space-between; align-items:center; gap:12px; }
    .modal-body { margin-top: 12px; }
    .modal-footer { display:flex; justify-content:flex-end; gap:12px; margin-top: 18px; }

    .checkbox-cell input[type="checkbox"] { width: 18px; height: 18px; }

    /* responsive */
    @media (max-width: 992px) {
      .table-header, .table-row-card { grid-template-columns: 1fr 2fr 1fr; }
      .table-row-card .table-cell:nth-child(4),
      .table-header .header-cell:nth-child(4),
      .table-row-card .table-cell:nth-child(5),
      .table-header .header-cell:nth-child(5) { display:none; }
    }
    
  </style>
</head>
<body>

<!-- SUCCESS MESSAGE -->
<% if (import_success) { %>
  <div class="success-alert">
    <i class="fas fa-check-circle"></i> Question imported successfully!
  </div>
<% } %>
<!-- ‚ñë‚ñë‚ñë TOP NAV ‚ñë‚ñë‚ñë -->
<div class="top-nav">
  <div class="nav-title">QUESTION LIST</div>

  <a href="/teacher/question-bank" class="nav-back-btn">
    <i class="fas fa-arrow-left"></i>
  </a>
</div>

<!-- TOP BUTTONS -->
<div class="header-actions">

  <!-- <a href="/teacher/question-bank" class="back-nav-btn" title="Back">
    <i class="fas fa-arrow-left"></i>
  </a> -->

  <div style="display:flex; gap:10px; align-items:center;">
   <a href="/teacher/question-bank/<%= course_id %>/<%= class_id %>/ai-image"
   class="btn btn-outline-primary">
   Generate From Image
</a>


    <% if (questions.length > 0) { %>
      <a href="/teacher/question-bank/<%= course_id %>/<%= class_id %>/ai" class="btn-bulk">
         ü§ñ Generate with AI
      </a>
    <% } %>

    <!-- Bulk add button opens modal -->
    <button id="openBulkBtn" class="btn-bulk" title="Bulk add selected to CBT" disabled>
      <i class="fa-solid fa-layer-group"></i> Bulk Add to CBT
    </button>
  </div>

</div>

<!-- HEADER -->
<div class="header-section">
  <!-- <h1 class="header-title">QUESTION LIST</h1> -->
  <p class="header-subtitle">Manage questions for <%= course_name %> ‚Äî <%= class_name %></p>
</div>

<!-- TABLE HEADER -->
<div class="table-header">
  <div class="select-all">
    <input id="selectAll" type="checkbox" aria-label="Select all questions" />
    <label for="selectAll">#</label>
  </div>
  <div>Question</div>
  <div>Options</div>
  <div>Correct</div>
  <div>Image</div>
  <div>Actions</div>
</div>

<!-- DROPDOWN OVERLAY (for closing on click outside) -->
<div class="dropdown-overlay" id="dropdownOverlay"></div>

<!-- DROPDOWN CONTAINER (positioned globally) -->
<div class="dropdown-menu-container" id="globalDropdownContainer">
  <div class="dropdown-menu-box" id="globalDropdownMenu">
    <!-- content injected in JS for single-row actions -->
  </div>
</div>

<!-- BULK MODAL -->
<div class="bulk-modal-backdrop" id="bulkBackdrop">
  <div class="bulk-modal" role="dialog" aria-modal="true" aria-labelledby="bulkTitle">
    <div class="modal-header">
      <h4 id="bulkTitle">Bulk Add Selected Questions to CBT</h4>
      <button id="closeBulk" class="btn btn-sm" title="Close">&times;</button>
    </div>

    <div class="modal-body">
      <p id="bulkCountText">Selected <strong id="bulkCount">0</strong> question(s).</p>

      <label><strong>Choose Exam</strong></label>
      <select id="bulkExamSelect" class="form-select" required>
        <option value="">Select Exam</option>
        <% exams.forEach(ex => { %>
          <option value="<%= ex.id %>"><%= ex.title %> ‚Äî <%= ex.class_name %></option>
        <% }) %>
      </select>

      <div style="margin-top:10px;">
        <label><strong>Or create exam first</strong></label>
        <div>
          <a href="/teacher/cbt" class="btn btn-link">Go to CBT Dashboard</a>
        </div>
      </div>

      <div id="bulkAlert" style="display:none;margin-top:12px;"></div>
    </div>

    <div class="modal-footer">
      <button id="cancelBulk" class="btn btn-secondary">Cancel</button>
      <button id="confirmBulk" class="btn btn-primary">Add to Exam</button>
    </div>
  </div>
</div>

<!-- TABLE BODY -->
<div class="table-body">

  <% questions.forEach((q, i) => { %>
  <div class="table-row-card">

    <!-- Number + checkbox -->
    <div class="table-cell checkbox-cell">
      <input class="bulk-checkbox" type="checkbox" value="<%= q.id %>" aria-label="Select question <%= i+1 %>">
      <span><%= i + 1 %></span>
    </div>

  

    <!-- Question -->
    <div class="table-cell question-text"><%= q.question %></div>

    <!-- Options -->
<div class="table-cell option-column">
    <div class="option-item"><strong>A:</strong> <%= q.option1 %></div>
    <div class="option-item"><strong>B:</strong> <%= q.option2 %></div>
    <div class="option-item"><strong>C:</strong> <%= q.option3 || "‚Äî" %></div>
    <div class="option-item"><strong>D:</strong> <%= q.option4 || "‚Äî" %></div>
</div>


    <!-- Correct -->
    <div class="table-cell">
      <% const L = {1:"A",2:"B",3:"C",4:"D"}; %>
      <span class="correct-badge">
        <%= L[q.correct_option] || q.correct_option || "?" %>
      </span>
    </div>


    <!-- Image -->
    <div class="table-cell">
      <% if (q.image_path) { %>
        <img src="/uploads/question_bank/<%= q.image_path %>" class="question-img" alt="q image">
      <% } else { %>
        <em style="color:#94a3b8;">No Image</em>
      <% } %>
    </div>

    <!-- ACTIONS: keep existing single-row import + edit/delete -->
    <div class="table-cell action-cell-wrapper">
      <button class="action-btn" 
              data-question-id="<%= q.id %>" 
              data-question-index="<%= i %>">
        Actions <i class="fas fa-chevron-down"></i>
      </button>
    </div>

    <div class="table-cell">
  <% if (q.question_image) { %>
    <img src="/uploads/questions/<%= q.question_image %>"
         class="question-img"
         alt="question image">
  <% } else { %>
    <em style="color:#94a3b8;">No Image</em>
  <% } %>
</div>


  </div>
  <% }) %>

  <% if (questions.length === 0) { %>
    <div style="text-align:center; padding:40px; color:#64748b; background:white; border-radius:8px; border:1px dashed #e2e8f0;">
      No questions available.
    </div>
  <% } %>

</div>

<!-- PAGINATION -->
<div class="d-flex justify-content-center mt-4 mb-5">
  <nav>
    <ul class="pagination">
      <!-- Previous button -->
      <li class="page-item <%= page === 1 ? 'disabled' : '' %>">
        <a class="page-link" href="?page=<%= page - 1 %>">&laquo; Prev</a>
      </li>

      <!-- Page numbers -->
      <% for (let p = 1; p <= totalPages; p++) { %>
        <li class="page-item <%= p === page ? 'active' : '' %>">
          <a class="page-link" href="?page=<%= p %>"><%= p %></a>
        </li>
      <% } %>

      <!-- Next button -->
      <li class="page-item <%= page === totalPages ? 'disabled' : '' %>">
        <a class="page-link" href="?page=<%= page + 1 %>">Next &raquo;</a>
      </li>
    </ul>
  </nav>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Elements
  const selectAll = document.getElementById('selectAll');
  const checkboxes = Array.from(document.querySelectorAll('.bulk-checkbox'));
  const openBulkBtn = document.getElementById('openBulkBtn');
  const bulkBackdrop = document.getElementById('bulkBackdrop');
  const closeBulk = document.getElementById('closeBulk');
  const cancelBulk = document.getElementById('cancelBulk');
  const confirmBulk = document.getElementById('confirmBulk');
  const bulkExamSelect = document.getElementById('bulkExamSelect');
  const bulkCount = document.getElementById('bulkCount');
  const bulkAlert = document.getElementById('bulkAlert');

  // Dropdown global
  const dropdownContainer = document.getElementById('globalDropdownContainer');
  const dropdownMenu = document.getElementById('globalDropdownMenu');
  let currentQuestionId = null;

  // Utility: update openBulkBtn enabled state
  function updateBulkButtonState() {
    const selected = checkboxes.filter(c => c.checked).length;
    openBulkBtn.disabled = selected === 0;
    bulkCount.textContent = selected;
  }

  // Select / deselect all
  selectAll && selectAll.addEventListener('change', () => {
    checkboxes.forEach(cb => cb.checked = selectAll.checked);
    updateBulkButtonState();
  });

  // each checkbox update
  checkboxes.forEach(cb => {
    cb.addEventListener('change', () => {
      if (!cb.checked) selectAll.checked = false;
      else if (checkboxes.every(c => c.checked)) selectAll.checked = true;
      updateBulkButtonState();
    });
  });

  updateBulkButtonState(); // initial

  // Open bulk modal
  openBulkBtn.addEventListener('click', () => {
    const selectedIds = checkboxes.filter(c => c.checked).map(c => c.value);
    if (!selectedIds.length) return; // should be disabled already
    bulkAlert.style.display = 'none';
    bulkBackdrop.style.display = 'flex';
  });

  // Close bulk modal helpers
  function closeBulkModal() {
    bulkBackdrop.style.display = 'none';
    bulkExamSelect.value = "";
    bulkAlert.style.display = 'none';
  }
  closeBulk.addEventListener('click', closeBulkModal);
  cancelBulk.addEventListener('click', closeBulkModal);

  // Confirm bulk import (POST JSON to /teacher/cbt/import/bulk)
  confirmBulk.addEventListener('click', async () => {
    const examId = bulkExamSelect.value;
    if (!examId) {
      bulkAlert.style.display = 'block';
      bulkAlert.innerHTML = '<div style="padding:10px;border-radius:6px;background:#fff3cd;color:#856404;border:1px solid #ffeeba;">Please select an exam.</div>';
      return;
    }

    const selectedIds = checkboxes.filter(c => c.checked).map(c => Number(c.value));
    if (!selectedIds.length) {
      bulkAlert.style.display = 'block';
      bulkAlert.innerHTML = '<div style="padding:10px;border-radius:6px;background:#ffe2e2;color:#7a1f1f;border:1px solid #ffc9c9;">No questions selected.</div>';
      return;
    }

    // Disable button while sending
    confirmBulk.disabled = true;
    confirmBulk.textContent = 'Adding...';

    try {
      const resp = await fetch('/teacher/cbt/import/bulk', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ exam_id: examId, questions: JSON.stringify(selectedIds) })
      });

      const data = await resp.json();

      if (resp.ok && data && data.success) {
        // success toast then reload
        bulkAlert.style.display = 'block';
        bulkAlert.innerHTML = '<div style="padding:10px;border-radius:6px;background:#d1fae5;color:#064e3b;border:1px solid #bbf7d0;">Added ' + (data.added || selectedIds.length) + ' question(s) to exam.</div>';
        setTimeout(() => {
          // close and reload same page to reflect changes
          closeBulkModal();
          window.location.reload();
        }, 900);
      } else {
        bulkAlert.style.display = 'block';
        bulkAlert.innerHTML = '<div style="padding:10px;border-radius:6px;background:#ffe4e6;color:#9b1c1c;border:1px solid #ffccd5;">Error: ' + (data.error || 'Request failed') + '</div>';
      }
    } catch (err) {
      bulkAlert.style.display = 'block';
      bulkAlert.innerHTML = '<div style="padding:10px;border-radius:6px;background:#ffe4e6;color:#9b1c1c;border:1px solid #ffccd5;">Network error</div>';
      console.error(err);
    } finally {
      confirmBulk.disabled = false;
      confirmBulk.textContent = 'Add to Exam';
    }
  });

  // Single-row action dropdown (existing behavior)
  document.querySelectorAll('.action-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      e.preventDefault();
      const qid = this.getAttribute('data-question-id');

      // Close existing
      dropdownContainer.style.display = 'block';
      dropdownMenu.classList.remove('active');

      // position near button
      const rect = this.getBoundingClientRect();
      const left = Math.min(rect.right - 260, window.innerWidth - 280);
      const top = rect.bottom + 10;
      dropdownMenu.style.left = left + 'px';
      dropdownMenu.style.top = top + 'px';

      // inject content (single-import form, edit, delete)
      dropdownMenu.innerHTML = `
        <form action="/teacher/cbt/import-question" method="POST" style="margin:0 0 8px 0;">
          <select name="examId" required class="form-select mb-2">
            <option value="">Select Exam</option>
            <% exams.forEach(ex => { %>
              <option value="<%= ex.id %>"><%= ex.title %> ‚Äî <%= ex.class_name %></option>
            <% }) %>
          </select>
          <input type="hidden" name="qid" value="${qid}">
          <button type="submit" class="btn btn-sm" style="width:100%; background:#f1f5f9; border:1px solid #e2e8f0; padding:8px; border-radius:6px; font-weight:600;">
            <i class="fas fa-plus-circle"></i> Add ‚Üí Exam
          </button>
        </form>

        <a href="/teacher/question-bank/${qid}/edit" style="display:block; padding:10px; text-decoration:none; color:#334155; border-radius:6px; margin-bottom:6px;">
          <i class="fas fa-edit"></i> Edit Question
        </a>

        <form action="/teacher/question-bank/${qid}/delete" method="POST" style="margin:0;">
          <button type="submit" style="width:100%; padding:10px; background:none; border:none; color:#e74a3b; text-align:left; border-radius:6px; cursor:pointer; font-weight:600;">
            <i class="fas fa-trash-alt"></i> Delete Question
          </button>
        </form>
      `;

      setTimeout(() => dropdownMenu.classList.add('active'), 10);
      currentQuestionId = qid;
    });
  });

  // Close dropdown when clicking outside
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.dropdown-menu-box') && !e.target.closest('.action-btn')) {
      dropdownContainer.style.display = 'none';
      dropdownMenu.classList.remove('active');
      currentQuestionId = null;
    }
  });

  // keyboard escape closes modals/dropdowns
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      dropdownContainer.style.display = 'none';
      dropdownMenu.classList.remove('active');
      closeBulkModal();
    }
  });
});
</script>

</body>
</html>

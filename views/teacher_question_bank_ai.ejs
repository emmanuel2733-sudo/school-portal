<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Question Generator</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    :root{--primary:#6366f1;--success:#10b981;--danger:#e74a3b;--card-bg:#f8fafc}
    *{box-sizing:border-box}
    body{background:#f1f5f9;font-family:Segoe UI,system-ui,Arial;margin:0;padding:24px}
    .container-card{max-width:1100px;margin:20px auto;background:#fff;border-radius:12px;padding:28px;border:1px solid #e6eef9;box-shadow:0 12px 30px rgba(16,24,40,0.06)}
    .row-grid{display:grid;grid-template-columns:1fr 420px;gap:22px}
    @media(max-width:900px){.row-grid{grid-template-columns:1fr}}
    h1{margin:0 0 6px;font-size:1.6rem}
    p.lead{margin:0 0 20px;color:#6b7280}
    label{font-weight:700;margin-bottom:6px;display:block}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid #e6eef9;border-radius:8px}
    .btn-primary{background:var(--primary);border:none}
    .btn-primary:disabled{opacity:0.6}
    .result-area{background:var(--card-bg);padding:12px;border-radius:8px;border:1px solid #eef2ff;max-height:560px;overflow:auto}
    .q-card{background:white;border-radius:8px;padding:12px;border:1px solid #e8eefc;margin-bottom:12px}
    .q-card b{display:block;margin-bottom:8px}
    .meta-row{display:flex;gap:8px;align-items:center;margin-bottom:10px}
    .chip{background:#eef2ff;color:var(--primary);padding:6px 10px;border-radius:999px;font-weight:700}
    .toast-wrap{position:fixed;right:20px;bottom:20px;z-index:1200}
    .small-muted{color:#6b7280;font-size:0.95rem}
  </style>
</head>
<body>

  <nav style="max-width:1100px;margin:0 auto 18px;display:flex;justify-content:space-between;align-items:center">
    <div style="display:flex;gap:12px;align-items:center">
      <a href="/teacher/question-bank/<%= course_id %>/<%= class_id %>/questions" class="btn btn-outline-secondary"><i class="fas fa-arrow-left"></i> Back</a>
      <h2 style="margin:0">AI Question Generator</h2>
    </div>
    <div class="small-muted">Course: <strong><%= course_id %></strong> • Class: <strong><%= class_id %></strong></div>
  </nav>

  <div class="container-card">
    <div class="row-grid">

      <!-- LEFT: Form + Results -->
      <div>
        <p class="lead">Generate multiple-choice questions instantly. The generated questions will appear below and you can save them straight into this course's question bank (no extra prompts).</p>

        <div style="margin-bottom:14px">
          <label for="topic">Topic / Instruction</label>
          <input id="topic" placeholder="e.g. Photosynthesis" />
        </div>

        <div style="display:flex;gap:12px;margin-bottom:14px">
          <div style="flex:1">
            <label for="difficulty">Difficulty</label>
            <select id="difficulty">
              <option value="easy">Easy</option>
              <option value="medium" selected>Medium</option>
              <option value="hard">Hard</option>
            </select>
          </div>

          <div style="width:140px">
            <label for="count">Count</label>
            <select id="count">
              <option value="5">5</option>
              <option value="10">10</option>
              <option value="20">20</option>
            </select>
          </div>
        </div>

        <div style="display:flex;gap:12px;margin-bottom:18px">
          <button id="genBtn" class="btn btn-primary" onclick="generateAI()"><i class="fas fa-robot"></i>&nbsp; Generate</button>
          <button id="clearBtn" class="btn btn-outline-secondary" onclick="clearResults()">Clear</button>
        </div>

        <div id="result" class="result-area">
          <div class="small-muted">No generated questions yet — click Generate to start.</div>
        </div>

        <div style="margin-top:16px;display:flex;gap:12px">
          <button id="saveBtn" class="btn btn-success" style="flex:1;display:none" onclick="saveToBank()"><i class="fas fa-save"></i>&nbsp; Save all to question bank</button>
          <button id="downloadBtn" class="btn btn-outline-secondary" style="display:none" onclick="downloadJSON()">Download JSON</button>
        </div>
      </div>

      <!-- RIGHT: Preview / Quick Options -->
      <aside>
        <div style="background:#fff;padding:18px;border-radius:8px;border:1px solid #eef2ff;margin-bottom:12px">
          <div class="meta-row"><span class="chip">Live</span><div class="small-muted">AI model used: <strong>server-configured</strong></div></div>
          <p class="small-muted">Generated questions will be saved directly to the question bank for this course & class. You won't be prompted for IDs — they are embedded from the page context.</p>
        </div>

        <div style="background:#fff;padding:16px;border-radius:8px;border:1px solid #eef2ff">
          <h5 style="margin:0 0 8px">Tips</h5>
          <ul style="margin:0 0 0 18px;padding:0;color:#6b7280">
            <li>Keep prompts short & focused (topic + level).</li>
            <li>Use count 5 or 10 for better relevance.</li>
            <li>Review before saving — you can edit questions afterward.</li>
          </ul>
        </div>
      </aside>

    </div>
  </div>


  <!-- Toast area -->
  <div class="toast-wrap" id="toastWrap"></div>

<script>
  // client-side state
  let generatedQuestions = [];
  const courseId = '<%= course_id %>';
  const classId = '<%= class_id %>';

  function showToast(msg, success=true, timeout=3500) {
    const el = document.createElement('div');
    el.className = 'toast p-3 mb-2';
    el.style.background = success ? '#dcfce7' : '#fee2e2';
    el.style.border = success ? '1px solid #86efac' : '1px solid #fca5a5';
    el.innerHTML = `<strong style="display:block;margin-bottom:6px">${success? 'Success':'Error'}</strong><div>${msg}</div>`;
    document.getElementById('toastWrap').appendChild(el);
    setTimeout(()=> el.remove(), timeout);
  }

  function clearResults(){
    generatedQuestions = [];
    document.getElementById('result').innerHTML = '<div class="small-muted">No generated questions yet — click Generate to start.</div>';
    document.getElementById('saveBtn').style.display = 'none';
    document.getElementById('downloadBtn').style.display = 'none';
  }

  async function generateAI(){
    const topic = document.getElementById('topic').value.trim();
    const count = Number(document.getElementById('count').value) || 5;
    const difficulty = document.getElementById('difficulty').value;

    if(!topic){ alert('Please enter a topic/brief.'); return; }

    // ui
    const resultEl = document.getElementById('result');
    resultEl.innerHTML = `<div style="text-align:center;padding:26px;color:#6b7280"><i class="fas fa-spinner fa-spin" style="font-size:26px;color:var(--primary)"></i><div style="margin-top:8px">Generating ${count} ${difficulty} questions...</div></div>`;
    document.getElementById('genBtn').disabled = true;

    try{
      const resp = await fetch('/teacher/question-bank/ai-generate', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ topic, count, difficulty })
      });

      const data = await resp.json();
      if(!data || !data.success || !Array.isArray(data.questions)){
        throw new Error((data && data.error) || 'Unexpected AI response');
      }

      generatedQuestions = data.questions.map((q, i)=>{
        // normalize keys: accept A/B or optionA names
        return {
          question: q.question || q.Q || q.prompt || '',
          optionA: q.optionA || q.option1 || q.A || '',
          optionB: q.optionB || q.option2 || q.B || '',
          optionC: q.optionC || q.option3 || q.C || '',
          optionD: q.optionD || q.option4 || q.D || '',
          correct_option: (typeof q.correct_option === 'string') ? q.correct_option.trim() : q.correct_option
        };
      });

      renderGenerated();
      showToast('AI generated questions ready — review then save.', true);

    }catch(err){
      console.error('AI generate error', err);
      resultEl.innerHTML = `<div style="padding:18px" class="text-danger">AI error: ${err.message || err}</div>`;
      showToast('AI generation failed. See console for details.', false, 6000);
    }finally{
      document.getElementById('genBtn').disabled = false;
    }
  }

  function renderGenerated(){
    const out = [];
    generatedQuestions.forEach((q, idx)=>{
      out.push(`
        <div class="q-card">
          <b>${idx+1}. ${escapeHtml(q.question)}</b>
          <div><strong>A:</strong> ${escapeHtml(q.optionA)}</div>
          <div><strong>B:</strong> ${escapeHtml(q.optionB)}</div>
          <div><strong>C:</strong> ${escapeHtml(q.optionC || '—')}</div>
          <div><strong>D:</strong> ${escapeHtml(q.optionD || '—')}</div>
          <div style="margin-top:8px;color:#16a34a"><strong>Answer:</strong> ${escapeHtml(String(q.correct_option || '?'))}</div>
        </div>
      `);
    });

    document.getElementById('result').innerHTML = out.join('');
    document.getElementById('saveBtn').style.display = generatedQuestions.length ? 'inline-block' : 'none';
    document.getElementById('downloadBtn').style.display = generatedQuestions.length ? 'inline-block' : 'none';
  }

  function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>\"']/g, function(c){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c]; }); }

  function downloadJSON(){
    const data = JSON.stringify(generatedQuestions, null, 2);
    const blob = new Blob([data], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `ai_questions_course_${courseId}_class_${classId}.json`; a.click(); URL.revokeObjectURL(url);
  }

  async function saveToBank(){
    if(!generatedQuestions.length){ alert('No generated questions to save.'); return; }

    // disable while saving
    const saveBtn = document.getElementById('saveBtn'); saveBtn.disabled = true; saveBtn.innerText = 'Saving...';

    try{
      const payload = { questions: JSON.stringify(generatedQuestions) };
      const res = await fetch(`/teacher/question-bank/${courseId}/${classId}/ai-generate/save`, {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
      });

      const data = await res.json();
      if(data && data.success){
        showToast(`Saved ${data.added || generatedQuestions.length} questions to bank.`);
        // redirect to questions list after short delay
        setTimeout(()=> window.location.href = `/teacher/question-bank/${courseId}/${classId}/questions?import=success`, 900);
      } else {
        throw new Error(data && (data.error || data.message) || 'Save failed');
      }

    }catch(err){
      console.error('Save error', err);
      showToast('Save failed: '+(err.message||err), false, 7000);
      alert('Save failed: '+(err.message||err));
    }finally{
      saveBtn.disabled = false; saveBtn.innerHTML = '<i class="fas fa-save"></i> Save all to question bank';
    }
  }

</script>

</body>
</html>

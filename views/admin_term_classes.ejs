<!DOCTYPE html>
<html>
<head>
  <title><%= termName %> – Classes</title>
  <link rel="stylesheet" href="/style.css">
  <style>
    table { border-collapse: collapse; width: 100%; margin: 20px 0; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
    th { background: #f2f2f2; }
    .btn { display: inline-block; padding: 6px 10px; margin: 2px; font-size: 0.9em; text-decoration: none; border-radius: 4px; color: #fff; }
.btn-primary { background: #007bff; }
.btn-primary:hover { background: #0056b3; }
.btn-success { background: #28a745; }
.btn-success:hover { background: #218838; }
.btn-danger { background: #dc3545; }
.btn-danger:hover { background: #c82333; }
.btn-info { background: #17a2b8; }
.btn-info:hover { background: #138496; }
  </style>
</head>
<body>
  <h1><%= termName %> (Year <%= year %>)</h1>

  <% if (successMsg) { %>
    <div style="color:green;background:#d4edda;padding:10px;margin:10px 0;border:1px solid #c3e6cb;border-radius:4px;">
      <%= successMsg %>
    </div>
  <% } %>
  <% if (errorMsg) { %>
    <div style="color:red;background:#f8d7da;padding:10px;margin:10px 0;border:1px solid #f5c6cb;border-radius:4px;">
      <%= errorMsg %>
    </div>
  <% } %>

  <h3>Classes</h3>
<table>
  <thead>
    <tr>
<th>Class</th>
<th>Teacher</th>
<th>Actions</th>
<th>Students</th>
    </tr>
  </thead>
  <tbody>
    <% if (classes.length === 0) { %>
      <tr><td colspan="4">No classes with students in this term.</td></tr>
    <% } else { %>
      <% classes.forEach(cls => { %>
        <tr>
          <td><strong><%= cls.name %></strong></td>
          <td>
            <% if (cls.teacher_name) { %>
              <%= cls.teacher_name %>
              <form action="/admin/class/<%= cls.id %>/remove-class-teacher?termId=<%= termId %>" method="POST" style="display:inline;" onsubmit="return confirm('Remove <%= cls.teacher_name %> as class teacher?');">
                <button type="submit" style="background:none;border:none;color:red;cursor:pointer;font-size:0.9em;">✕ Remove</button>
              </form>
            <% } else { %>
              <a href="/admin/class/<%= cls.id %>/class-teacher?termId=<%= termId %>" style="color:green;">Assign Teacher</a>
            <% } %>
          </td>
          <td>
            <a href="/admin/class/<%= cls.id %>/courses?termId=<%= termId %>">Manage Courses</a> |
            <a href="/admin/class/<%= cls.id %>/enroll?termId=<%= termId %>">Enroll Students</a>
          </td>
        <td>
  <a href="/admin/class/<%= cls.id %>/students?termId=<%= termId %>" 
     class="btn btn-info" style="margin:2px;">
    Students
  </a>
</td>
        </tr>
      <% }) %>
    <% } %>
  </tbody>
</table>

  <!-- <a href="/admin/academic-year/<%= year %>/terms" style="margin-top:20px;display:inline-block;">
    Back to Terms
  </a> -->
   <a href="/dashboard">Back to Dashboard</a>

  <!-- ================== JAVASCRIPT FOR CLASS TEACHER ASSIGNMENT ================== -->
  <script>
    // Assign a new class teacher
    function assignClassTeacher(classId, termId) {
      const username = prompt("Enter teacher's username:");
      if (!username || username.trim() === '') return;

      fetch(`/admin/class/${classId}/class-teacher`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ teacher_username: username.trim(), termId })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const span = document.getElementById('ct-name-' + classId);
          if (span) span.textContent = data.teacher_name;
          alert('Class teacher assigned: ' + data.teacher_name);
          location.reload(); // Refresh to show button changes
        } else {
          alert('Error: ' + data.error);
        }
      })
      .catch(err => {
        console.error(err);
        alert('Network error. Check console.');
      });
    }

    // Change existing class teacher
    function changeClassTeacher(classId, termId) {
      const username = prompt("Enter new teacher's username (or leave blank to remove):");
      if (username === null) return;

      const body = username && username.trim() !== ''
        ? { teacher_username: username.trim(), termId }
        : { remove: true, termId };

      fetch(`/admin/class/${classId}/class-teacher`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          if (data.removed) {
            document.getElementById('ct-name-' + classId).textContent = 'None';
            alert('Class teacher removed.');
          } else {
            document.getElementById('ct-name-' + classId).textContent = data.teacher_name;
            alert('Updated to: ' + data.teacher_name);
          }
          location.reload();
        } else {
          alert('Error: ' + data.error);
        }
      });
    }
  </script>
  <!-- ================== END OF JS ================== -->
</body>
</html>
